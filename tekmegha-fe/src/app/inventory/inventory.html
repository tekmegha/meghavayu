<div class="inventory-container">
  <div class="inventory-header">
    <div class="header-left">
      <h1>Inventory Management</h1>
      @if (currentUser) {
        <div class="user-info">
          <span class="material-icons">person</span>
          <span>{{ currentUser.email }}</span>
        </div>
      }
    </div>
    <div class="header-actions">
      <button class="add-product-btn" (click)="openAddModal()">
        <span class="material-icons">add</span>
        Add Product
      </button>
      <button class="logout-btn" (click)="onLogout()">
        <span class="material-icons">logout</span>
        Logout
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <span class="material-icons">inventory</span>
      </div>
      <div class="stat-content">
        <h3>{{ stats.totalProducts }}</h3>
        <p>Total Products</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <span class="material-icons">check_circle</span>
      </div>
      <div class="stat-content">
        <h3>{{ stats.activeProducts }}</h3>
        <p>Active Products</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <span class="material-icons">warning</span>
      </div>
      <div class="stat-content">
        <h3>{{ stats.lowStockProducts }}</h3>
        <p>Low Stock</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <span class="material-icons">error</span>
      </div>
      <div class="stat-content">
        <h3>{{ stats.outOfStockProducts }}</h3>
        <p>Out of Stock</p>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="filters-section">
    <div class="search-container">
      <span class="material-icons search-icon">search</span>
      <input 
        type="text" 
        class="search-input"
        placeholder="Search products..."
        [(ngModel)]="searchQuery"
        (input)="onSearch()"
      >
    </div>

    <div class="filter-container">
      <select class="filter-select" [(ngModel)]="filterStatus" (change)="onFilterChange()">
        <option value="all">All Products</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="lowStock">Low Stock</option>
        <option value="outOfStock">Out of Stock</option>
      </select>
    </div>
  </div>

  <!-- Products Table -->
  <div class="products-table-container">
    <table class="products-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>SKU</th>
          <th>Category</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (product of filteredProducts; track product.id) {
          <tr [class.inactive]="!product.is_active">
            <td class="product-info">
              <img [src]="product.image_url" [alt]="product.name" class="product-image" (error)="onImageError($event, product)">
              <div class="product-details">
                <h4>{{ product.name }}</h4>
                <p>{{ product.description }}</p>
              </div>
            </td>
            <td class="sku-cell">
              <span class="sku-text">{{ product.sku || 'N/A' }}</span>
            </td>
            <td>{{ product.category }}</td>
            <td>{{ formatCurrency(product.price) }}</td>
            <td>
              <div class="stock-controls">
                <input 
                  type="number" 
                  class="stock-input"
                  [value]="product.stock_quantity"
                  (change)="onUpdateStock(product, +$event.target.value)"
                  min="0"
                >
                <span class="stock-status" [class]="getStockStatus(product)">
                  {{ getStockStatusText(product) }}
                </span>
              </div>
            </td>
            <td>
              <button 
                class="status-toggle"
                [class.active]="product.is_active"
                (click)="onToggleStatus(product)"
              >
                {{ product.is_active ? 'Active' : 'Inactive' }}
              </button>
            </td>
            <td class="actions">
              <button class="action-btn edit" (click)="openEditModal(product)">
                <span class="material-icons">edit</span>
              </button>
              <button class="action-btn delete" (click)="openDeleteModal(product)">
                <span class="material-icons">delete</span>
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>

    @if (filteredProducts.length === 0) {
      <div class="no-products">
        <span class="material-icons">inventory_2</span>
        <h3>No products found</h3>
        <p>Try adjusting your search or filters</p>
      </div>
    }
  </div>

  <!-- Add Product Modal -->
  @if (showAddModal) {
    <div class="modal-overlay" (click)="closeModals()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Add New Product</h2>
          <button class="close-btn" (click)="closeModals()">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <div class="modal-body">
          <div class="form-group">
            <label>Product Name</label>
            <input type="text" [(ngModel)]="newProduct.name" placeholder="Enter product name">
          </div>

          <div class="form-group">
            <label>SKU (Stock Keeping Unit)</label>
            <input type="text" [(ngModel)]="newProduct.sku" placeholder="e.g., BB-ESP-001" maxlength="100">
            <small class="form-hint">Unique identifier for this product (e.g., BB-ESP-001)</small>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea [(ngModel)]="newProduct.description" placeholder="Enter product description"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Price (₹)</label>
              <input type="number" [(ngModel)]="newProduct.price" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
              <label>Category</label>
              <select [(ngModel)]="newProduct.category">
                @for (category of categories; track category) {
                  <option [value]="category">{{ category }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Product Number (for image path)</label>
            <input type="number" [(ngModel)]="productNumber" placeholder="e.g., 1" min="1" (ngModelChange)="onProductNumberChange()">
            <small class="form-hint">Will generate: assets/images/{{getBrandId()}}/products/{{productNumber || 1}}.png</small>
          </div>

          <div class="form-group">
            <label>Image URL (auto-generated or custom)</label>
            <input type="text" [(ngModel)]="newProduct.image_url" placeholder="Auto-generated or enter custom URL">
            <small class="form-hint">Leave empty to use auto-generated path, or enter custom URL</small>
          </div>

          @if (newProduct.image_url) {
            <div class="form-group">
              <label>Image Preview</label>
              <div class="image-preview">
                <img [src]="newProduct.image_url" [alt]="newProduct.name" (error)="onPreviewImageError($event)" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);">
              </div>
            </div>
          }

          <div class="form-row">
            <div class="form-group">
              <label>Stock Quantity</label>
              <input type="number" [(ngModel)]="newProduct.stock_quantity" placeholder="100" min="0">
            </div>
            <div class="form-group">
              <label>Low Stock Threshold</label>
              <input type="number" [(ngModel)]="newProduct.low_stock_threshold" placeholder="10" min="0">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Supplier</label>
              <input type="text" [(ngModel)]="newProduct.supplier" placeholder="Supplier name">
            </div>
            <div class="form-group">
              <label>Cost Price (₹)</label>
              <input type="number" [(ngModel)]="newProduct.cost_price" placeholder="0.00" step="0.01">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeModals()">Cancel</button>
          <button class="btn-primary" (click)="onAddProduct()">Add Product</button>
        </div>
      </div>
    </div>
  }

  <!-- Edit Product Modal -->
  @if (showEditModal && selectedProduct) {
    <div class="modal-overlay" (click)="closeModals()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Edit Product</h2>
          <button class="close-btn" (click)="closeModals()">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <div class="modal-body">
          <div class="form-group">
            <label>Product Name</label>
            <input type="text" [(ngModel)]="selectedProduct.name" placeholder="Enter product name">
          </div>

          <div class="form-group">
            <label>SKU (Stock Keeping Unit)</label>
            <input type="text" [(ngModel)]="selectedProduct.sku" placeholder="e.g., BB-ESP-001" maxlength="100">
            <small class="form-hint">Unique identifier for this product (e.g., BB-ESP-001)</small>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea [(ngModel)]="selectedProduct.description" placeholder="Enter product description"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Price (₹)</label>
              <input type="number" [(ngModel)]="selectedProduct.price" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
              <label>Category</label>
              <select [(ngModel)]="selectedProduct.category">
                @for (category of categories; track category) {
                  <option [value]="category">{{ category }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Product Number (for image path)</label>
            <input type="number" [(ngModel)]="editProductNumber" placeholder="e.g., 1" min="1" (ngModelChange)="onEditProductNumberChange()">
            <small class="form-hint">Will generate: assets/images/{{getBrandId()}}/products/{{editProductNumber || 1}}.png</small>
          </div>

          <div class="form-group">
            <label>Image URL (auto-generated or custom)</label>
            <input type="text" [(ngModel)]="selectedProduct.image_url" placeholder="Auto-generated or enter custom URL">
            <small class="form-hint">Leave empty to use auto-generated path, or enter custom URL</small>
          </div>

          @if (selectedProduct.image_url) {
            <div class="form-group">
              <label>Image Preview</label>
              <div class="image-preview">
                <img [src]="selectedProduct.image_url" [alt]="selectedProduct.name" (error)="onPreviewImageError($event)" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);">
              </div>
            </div>
          }

          <div class="form-row">
            <div class="form-group">
              <label>Stock Quantity</label>
              <input type="number" [(ngModel)]="selectedProduct.stock_quantity" placeholder="100" min="0">
            </div>
            <div class="form-group">
              <label>Low Stock Threshold</label>
              <input type="number" [(ngModel)]="selectedProduct.low_stock_threshold" placeholder="10" min="0">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Supplier</label>
              <input type="text" [(ngModel)]="selectedProduct.supplier" placeholder="Supplier name">
            </div>
            <div class="form-group">
              <label>Cost Price (₹)</label>
              <input type="number" [(ngModel)]="selectedProduct.cost_price" placeholder="0.00" step="0.01">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeModals()">Cancel</button>
          <button class="btn-primary" (click)="onUpdateProduct()">Update Product</button>
        </div>
      </div>
    </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteModal && selectedProduct) {
    <div class="modal-overlay" (click)="closeModals()">
      <div class="modal delete-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Delete Product</h2>
          <button class="close-btn" (click)="closeModals()">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <div class="modal-body">
          <p>Are you sure you want to delete <strong>{{ selectedProduct.name }}</strong>?</p>
          <p class="warning-text">This action cannot be undone.</p>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeModals()">Cancel</button>
          <button class="btn-danger" (click)="onDeleteProduct()">Delete Product</button>
        </div>
      </div>
    </div>
  }
</div>
